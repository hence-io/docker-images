#!/bin/bash

declare -x MARIADB_MAX_CONNECTIONS
declare -x MARIADB_CONNECT_TIMEOUT
declare -x MARIADB_WAIT_TIMEOUT
declare -x MARIADB_MAX_ALLOWED_PACKET
declare -x MARIADB_THREAD_CACHE_SIZE
declare -x MARIADB_SORT_BUFFER_SIZE
declare -x MARIADB_BULK_INSERT_BUFFER_SIZE
declare -x MARIADB_TMP_TABLE_SIZE
declare -x MARIADB_MAX_HEAP_TABLE_SIZE
declare -x MARIADB_MYISAM_RECOVER
declare -x MARIADB_KEY_BUFFER_SIZE
declare -x MARIADB_OPEN_FILES_LIMIT
declare -x MARIADB_TABLE_OPEN_CACHE
declare -x MARIADB_MYISAM_SORT_BUFFER_SIZE
declare -x MARIADB_CONCURRENT_INSERT
declare -x MARIADB_READ_BUFFER_SIZE
declare -x MARIADB_READ_RND_BUFFER_SIZE
declare -x MARIADB_QUERY_CACHE_LIMIT
declare -x MARIADB_QUERY_CACHE_SIZE
declare -x MARIADB_QUERY_CACHE_TYPE
declare -x MARIADB_LOG_WARNINGS
declare -x MARIADB_SLOW_QUERY_LOG
declare -x MARIADB_LONG_QUERY_TIME
declare -x MARIADB_LOG_SLOW_RATE_LIMIT
declare -x MARIADB_LOG_SLOW_VERBOSITY
declare -x MARIADB_INNODB_LOG_FILE_SIZE
declare -x MARIADB_INNODB_BUFFER_POOL_SIZE
declare -x MARIADB_LOG_BUFFER_SIZE
declare -x MARIADB_FILE_PER_TABLE
declare -x MARIADB_OPEN_FILES
declare -x MARIADB_IO_CAPACITY
declare -x MARIADB_FLUSH_METHOD
declare -x MARIADB_MAX_ALLOWED_PACKE
declare -x MARIADB_KEY_BUFFER
declare -x MARIADB_DEFAULT_CHARACTER_SET
declare -x MARIADB_CHARACTER_SET_SERVER
declare -x MARIADB_COLLATION_SERVER

if [ -z "${MARIADB_MAX_CONNECTIONS}" ]
then
  MARIADB_MAX_CONNECTIONS=100
fi

if [ -z "${MARIADB_CONNECT_TIMEOUT}" ]
then
  MARIADB_CONNECT_TIMEOUT=5
fi

if [ -z "${MARIADB_WAIT_TIMEOUT}" ]
then
  MARIADB_WAIT_TIMEOUT=600
fi

if [ -z "${MARIADB_MAX_ALLOWED_PACKET}" ]
then
  MARIADB_MAX_ALLOWED_PACKET=16M
fi

if [ -z "${MARIADB_THREAD_CACHE_SIZE}" ]
then
  MARIADB_THREAD_CACHE_SIZE=128
fi

if [ -z "${MARIADB_SORT_BUFFER_SIZE}" ]
then
  MARIADB_SORT_BUFFER_SIZE=4M
fi

if [ -z "${MARIADB_BULK_INSERT_BUFFER_SIZE}" ]
then
  MARIADB_BULK_INSERT_BUFFER_SIZE=16M
fi

if [ -z "${MARIADB_TMP_TABLE_SIZE}" ]
then
  MARIADB_TMP_TABLE_SIZE=32M
fi

if [ -z "${MARIADB_MAX_HEAP_TABLE_SIZE}" ]
then
  MARIADB_MAX_HEAP_TABLE_SIZE=32M
fi

if [ -z "${MARIADB_MYISAM_RECOVER}" ]
then
  MARIADB_MYISAM_RECOVER=BACKUP
fi

if [ -z "${MARIADB_KEY_BUFFER_SIZE}" ]
then
  MARIADB_KEY_BUFFER_SIZE=128M
fi

if [ -z "${MARIADB_OPEN_FILES_LIMIT}" ]
then
  MARIADB_OPEN_FILES_LIMIT=2000
fi

if [ -z "${MARIADB_TABLE_OPEN_CACHE}" ]
then
  MARIADB_TABLE_OPEN_CACHE=400
fi

if [ -z "${MARIADB_MYISAM_SORT_BUFFER_SIZE}" ]
then
  MARIADB_MYISAM_SORT_BUFFER_SIZE=512M
fi

if [ -z "${MARIADB_CONCURRENT_INSERT}" ]
then
  MARIADB_CONCURRENT_INSERT=2
fi

if [ -z "${MARIADB_READ_BUFFER_SIZE}" ]
then
  MARIADB_READ_BUFFER_SIZE=2M
fi

if [ -z "${MARIADB_READ_RND_BUFFER_SIZE}" ]
then
  MARIADB_READ_RND_BUFFER_SIZE=1M
fi

if [ -z "${MARIADB_QUERY_CACHE_LIMIT}" ]
then
  MARIADB_QUERY_CACHE_LIMIT=128K
fi

if [ -z "${MARIADB_QUERY_CACHE_SIZE}" ]
then
  MARIADB_QUERY_CACHE_SIZE=64M
fi

if [ -z "${MARIADB_QUERY_CACHE_TYPE}" ]
then
  MARIADB_QUERY_CACHE_TYPE=ON
fi

if [ -z "${MARIADB_LOG_WARNINGS}" ]
then
  MARIADB_LOG_WARNINGS=2
fi

if [ -z "${MARIADB_SLOW_QUERY_LOG}" ]
then
  MARIADB_SLOW_QUERY_LOG=0
fi

if [ -z "${MARIADB_LONG_QUERY_TIME}" ]
then
  MARIADB_LONG_QUERY_TIME=10
fi

if [ -z "${MARIADB_LOG_SLOW_RATE_LIMIT}" ]
then
  MARIADB_LOG_SLOW_RATE_LIMIT=50
fi

if [ -z "${MARIADB_LOG_SLOW_VERBOSITY}" ]
then
  MARIADB_LOG_SLOW_VERBOSITY=query_plan
fi

if [ -z "${MARIADB_INNODB_LOG_FILE_SIZE}" ]
then
  MARIADB_INNODB_LOG_FILE_SIZE=5M
fi

if [ -z "${MARIADB_INNODB_BUFFER_POOL_SIZE}" ]
then
  MARIADB_INNODB_BUFFER_POOL_SIZE=256M
fi

if [ -z "${MARIADB_LOG_BUFFER_SIZE}" ]
then
  MARIADB_LOG_BUFFER_SIZE=8M
fi

if [ -z "${MARIADB_FILE_PER_TABLE}" ]
then
  MARIADB_FILE_PER_TABLE=1
fi

if [ -z "${MARIADB_OPEN_FILES}" ]
then
  MARIADB_OPEN_FILES=400
fi

if [ -z "${MARIADB_IO_CAPACITY}" ]
then
  MARIADB_IO_CAPACITY=400
fi

if [ -z "${MARIADB_FLUSH_METHOD}" ]
then
  MARIADB_FLUSH_METHOD=O_DIRECT
fi

if [ -z "${MARIADB_MAX_ALLOWED_PACKE}" ]
then
  MARIADB_MAX_ALLOWED_PACKE=16M
fi

if [ -z "${MARIADB_KEY_BUFFER}" ]
then
  MARIADB_KEY_BUFFER=16M
fi

if [ -z "${MARIADB_DEFAULT_CHARACTER_SET}" ]
then
  MARIADB_DEFAULT_CHARACTER_SET=utf8
fi

if [ -z "${MARIADB_CHARACTER_SET_SERVER}" ]
then
  MARIADB_CHARACTER_SET_SERVER=utf8
fi

if [ -z "${MARIADB_COLLATION_SERVER}" ]
then
  MARIADB_COLLATION_SERVER=utf8_general_ci
fi

envsubst < $HENCE_APP_VOL_PREFIX/conf/conf.d/mariadb.cnf.tmpl > $HENCE_APP_VOL_PREFIX/conf/conf.d/mariadb.cnf
envsubst < $HENCE_APP_VOL_PREFIX/conf/my.cnf.tmpl > $HENCE_APP_VOL_PREFIX/conf/my.cnf

# symlink in our custom socket for mysql client connections
mkdir -p /run/mysqld
ln -s /opt/hence/mysql/tmp/mysql.sock /run/mysqld/mysqld.sock
