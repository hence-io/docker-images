listen 80;

root /app;
index index.php index.html index.htm;

disable_symlinks off;

location = /favicon.ico {
  log_not_found off;
  access_log off;
}

location = /robots.txt {
  allow all;
  log_not_found off;
  access_log off;
}

location ~ ^/(?:\.htaccess){
  deny all;
}

location ~ /\.ht {
  deny all;
}

location ~ \.php(?:${DOLLAR}|/) {
  try_files ${DOLLAR}uri =404;

  fastcgi_pass ${NGINX_PHP_ALIAS}:9000;
  fastcgi_index index.php;
  include $HENCE_APP_VOL_PREFIX/conf/fastcgi.conf;
  fastcgi_intercept_errors on;
}

# This matters if you use drush
location = /backup {
  deny all;
}

location ~ \..*/.*\.php${DOLLAR} {
  return 403;
}

location / {
  # This is cool because no php is touched for static content
  try_files ${DOLLAR}uri @rewrite;
  index  index.html index.htm index.php;
}

location @rewrite {
  # Some modules enforce no slash (/) at the end of the URL
  # Else this rewrite block wouldn't be needed (GlobalRedirect)
  rewrite ^/(.*)${DOLLAR} /index.php?q=${DOLLAR}1;
}

# Fighting with ImageCache? This little gem is amazing.
location ~ ^/sites/.*/files/imagecache/ {
  try_files ${DOLLAR}uri @rewrite;
}

# Catch image styles for D7 too.
location ~ ^/sites/.*/files/styles/ {
  try_files ${DOLLAR}uri @rewrite;
}

location ~* \.(js|css|png|jpg|jpeg|gif|ico)${DOLLAR} {
  expires max;
  log_not_found off;
}

# Needed for lastest versions of backup_migrate module
location ^~ /backup_migrate/ {
  internal;
}

