#!/bin/bash

export DOLLAR="$" # Needed to keep envsubst from destroying nginx variables in conf.tmpl files
declare -x NGINX_PHP_ALIAS
declare -x NGINX_PROXY_PATH
declare -x NGINX_PROXY_HOST
declare -x NGINX_PROXY_PORT
declare -x NGINX_SSL_INCLUDE
declare -x NGINX_SSL_CERT_FILE
declare -x NGINX_SSL_CERT_KEY_FILE
declare -x NGINX_FASTCGI_READ_TIMEOUT
declare -x NGINX_FASTCGI_IGNORE_CLIENT_ABORT
declare -x NGINX_CLIENT_MAX_BODY_SIZE
declare -x NGINX_CLIENT_BODY_BUFFER_SIZE

if [ -z "${NGINX_PHP_ALIAS}" ]
then
  NGINX_PHP_ALIAS=php
fi

if [ -z "${NGINX_PROXY_PATH}" ]
then
  NGINX_PROXY_PATH=rest/api
fi

if [ -z "${NGINX_PROXY_HOST}" ]
then
  NGINX_PROXY_HOST=localhost
fi

if [ -z "${NGINX_PROXY_PORT}" ]
then
  NGINX_PROXY_PORT=3000
fi

if [ -z "${NGINX_SSL_INCLUDE}" ]
then
  NGINX_SSL_INCLUDE=""
fi

if [ -z "${NGINX_SSL_CERT_FILE}" ]
then
  NGINX_SSL_CERT_FILE=""
fi

if [ -z "${NGINX_SSL_CERT_KEY_FILE}" ]
then
  NGINX_SSL_CERT_KEY_FILE=""
fi


if [ -z "${NGINX_FASTCGI_READ_TIMEOUT}" ]
then
  NGINX_FASTCGI_READ_TIMEOUT=300
fi

if [ -z "${NGINX_FASTCGI_IGNORE_CLIENT_ABORT}" ]
then
  NGINX_FASTCGI_IGNORE_CLIENT_ABORT=off
fi

if [ -z "${NGINX_CLIENT_MAX_BODY_SIZE}" ]
then
  NGINX_CLIENT_MAX_BODY_SIZE=128m
fi

if [ -z "${NGINX_CLIENT_BODY_BUFFER_SIZE}" ]
then
  NGINX_CLIENT_BODY_BUFFER_SIZE=128k
fi

chown -R $HENCE_APP_USER:www-data \
  /var/lib/nginx

if [ -n "${NGINX_CONFIG_PRESET}" ]
then
  sed -i "s/presets\/default/presets\/${NGINX_CONFIG_PRESET}/" $HENCE_APP_VOL_PREFIX/conf/nginx.conf.tmpl

  envsubst < $HENCE_APP_VOL_PREFIX/conf/presets/$NGINX_CONFIG_PRESET.conf.tmpl > $HENCE_APP_VOL_PREFIX/conf/presets/$NGINX_CONFIG_PRESET.conf
fi

if [ "${ENABLE_SSL}" = "1" ]
then
  NGINX_SSL_INCLUDE="include $HENCE_APP_VOL_PREFIX/conf/presets/ssl.conf;"

  envsubst < $HENCE_APP_VOL_PREFIX/conf/presets/ssl.conf.tmpl > $HENCE_APP_VOL_PREFIX/conf/presets/ssl.conf
fi

sed -i "s/\$NGINX_SSL_INCLUDE/${NGINX_SSL_INCLUDE}/" $HENCE_APP_VOL_PREFIX/conf/nginx.conf.tmpl

envsubst < $HENCE_APP_VOL_PREFIX/conf/nginx.conf.tmpl > $HENCE_APP_VOL_PREFIX/conf/nginx.conf
