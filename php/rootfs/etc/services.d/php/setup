#!/bin/bash

declare -x CONFIG_PRESET
declare -x PHP_MEMORY_LIMIT
declare -x PHP_POST_MAX_SIZE
declare -x PHP_UPLOAD_MAX_FILESIZE
declare -x PHP_MAX_EXECUTION_TIME
declare -x PHP_MAX_INPUT_TIME
declare -x PHP_DATE_TIMEZONE
declare -x PHP_REALPATH_CACHE_SIZE
declare -x PHP_OPCACHE_ENABLE
declare -x PHP_OPCACHE_ENABLE_CLI
declare -x PHP_OPCACHE_MEMORY_CONSUMPTION
declare -x PHP_OPCACHE_INTERNAL_STRINGS_BUFFER
declare -x PHP_OPCACHE_MAX_ACCELERATED_FILES
declare -x PHP_OPCACHE_VALIDATE_TIMESTAMPS
declare -x PHP_OPCACHE_REVALIDATE_FREQ
declare -x PHP_OPCACHE_FAST_SHUTDOWN
declare -x PHP_OPCACHE_ENABLE_FILE_OVERRIDE

if [ -z "${PHP_MEMORY_LIMIT}" ]
then
  PHP_MEMORY_LIMIT=512M
fi

if [ -z "${PHP_POST_MAX_SIZE}" ]
then
  PHP_POST_MAX_SIZE=128M
fi

if [ -z "${PHP_UPLOAD_MAX_FILESIZE}" ]
then
  PHP_UPLOAD_MAX_FILESIZE=128M
fi

if [ -z "${PHP_MAX_EXECUTION_TIME}" ]
then
  PHP_MAX_EXECUTION_TIME=180
fi

if [ -z "${PHP_MAX_INPUT_TIME}" ]
then
  PHP_MAX_INPUT_TIME=180
fi

if [ -z "${PHP_DATE_TIMEZONE}" ]
then
  PHP_DATE_TIMEZONE=UTC
fi

if [ -z "${PHP_REALPATH_CACHE_SIZE}" ]
then
  PHP_REALPATH_CACHE_SIZE=1024k
fi

if [ -z "${PHP_OPCACHE_ENABLE}" ]
then
  PHP_OPCACHE_ENABLE=1
fi

if [ -z "${PHP_OPCACHE_ENABLE_CLI}" ]
then
  PHP_OPCACHE_ENABLE_CLI=0
fi

if [ -z "${PHP_OPCACHE_MEMORY_CONSUMPTION}" ]
then
  PHP_OPCACHE_MEMORY_CONSUMPTION=128
fi

if [ -z "${PHP_OPCACHE_INTERNAL_STRINGS_BUFFER}" ]
then
  PHP_OPCACHE_INTERNAL_STRINGS_BUFFER=8
fi

if [ -z "${PHP_OPCACHE_MAX_ACCELERATED_FILES}" ]
then
  PHP_OPCACHE_MAX_ACCELERATED_FILES=4000
fi

if [ -z "${PHP_OPCACHE_VALIDATE_TIMESTAMPS}" ]
then
  PHP_OPCACHE_VALIDATE_TIMESTAMPS=1
fi

if [ -z "${PHP_OPCACHE_REVALIDATE_FREQ}" ]
then
  PHP_OPCACHE_REVALIDATE_FREQ=60
fi

if [ -z "${PHP_OPCACHE_FAST_SHUTDOWN}" ]
then
  PHP_OPCACHE_FAST_SHUTDOWN=1
fi

if [ -z "${PHP_OPCACHE_ENABLE_FILE_OVERRIDE}" ]
then
  PHP_OPCACHE_ENABLE_FILE_OVERRIDE=1
fi

# If MYSQL_HOST is provided, then we set up phpmyadmin
if [ -n "${MYSQL_HOST}" ]
then
  cp -R $COMPOSER_HOME/vendor/fillup/phpmyadmin-minimal /vendor/phpmyadmin
  rm /app/phpmyadmin && ln -sf /vendor/phpmyadmin /app/phpmyadmin
fi

envsubst < $HENCE_APP_VOL_PREFIX/conf/php.ini.tmpl > $HENCE_APP_VOL_PREFIX/conf/php.ini
